server:
  enabled: false

rbac:
  create: true

serviceAccount:
  create: true

remoteWrite:
  - url: "__REMOTE_WRITE_URL__"

extraArgs:
  promscrape.streamParse: "true"

config:
  global:
    scrape_interval: 5s
    scrape_timeout: 4s

  scrape_configs:
    - job_name: "kubernetes-pods"
      kubernetes_sd_configs:
        - role: pod
      relabel_configs:
        - action: keep
          source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          regex: "true"
        - action: replace
          source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
          target_label: __metrics_path__
          regex: (.+)
        - action: replace
          source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
          target_label: __address__
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
          
        # Add unique labels so targets don't collapse into duplicates
        - action: replace
          source_labels: [__meta_kubernetes_namespace]
          target_label: namespace
        - action: replace
          source_labels: [__meta_kubernetes_pod_name]
          target_label: pod
        - action: replace
          source_labels: [__meta_kubernetes_pod_container_name]
          target_label: container
        - action: replace
          source_labels: [__meta_kubernetes_pod_node_name]
          target_label: node
    - job_name: "kubelet-cadvisor"
      scheme: https
      kubernetes_sd_configs:
        - role: node
      metrics_path: /metrics/cadvisor

      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        insecure_skip_verify: true

      relabel_configs:
        # force kubelet port
        - action: replace
          source_labels: [__address__]
          target_label: __address__
          regex: (.+):\d+
          replacement: $1:10250

        # add node name label
        - action: replace
          source_labels: [__meta_kubernetes_node_name]
          target_label: node